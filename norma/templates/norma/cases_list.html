{% extends 'norma/base.html' %}
{% load static %}

<style>
    .case-item.active {
        background-color: #007bff !important;
        color: white !important;
        border-color: #007bff !important;
    }
    
    .case-item.active h6,
    .case-item.active p,
    .case-item.active small,
    .case-item.active .text-muted {
        color: white !important;
    }
    
    .case-item.active .badge {
        background-color: white !important;
        color: #007bff !important;
    }
    
    .case-item.active .form-check-label {
        color: white !important;
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è —Ç–µ–∫—Å—Ç–∞ —Å—Ü–µ–Ω–∞—Ä–∏—è */
    .scenario-text {
        white-space: pre-wrap;
        word-wrap: break-word;
        line-height: 1.5;
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
        border: 1px solid #e9ecef;
        max-height: 400px;
        overflow-y: auto;
    }
    
    .status-badge {
        font-size: 0.9em;
        padding: 0.5em 0.8em;
    }
</style>

{% block content %}
<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>–¢–µ—Å—Ç-–∫–µ–π—Å—ã –ø—Ä–æ–µ–∫—Ç–∞: {{ project.title }}</h1>
        <div>
            <a href="{% url 'proj_dashboard' pk=project.pk %}" class="btn btn-secondary">
                ‚Üê –ù–∞–∑–∞–¥ –∫ –ø—Ä–æ–µ–∫—Ç—É
            </a>
            <button type="button" class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#caseModal">
                + –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç-–∫–µ–π—Å
            </button>
            <button type="button" class="btn btn-success" id="createLaunchBtnOpen" data-bs-toggle="modal" data-bs-target="#launchModal">
                + –°–æ–∑–¥–∞—Ç—å –∑–∞–ø—É—Å–∫ (<span id="selectedCountHeader">0</span>)
            </button>
        </div>
    </div>

    <div class="row">
        <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–µ–π—Å—ã -->
        <div class="col-md-5">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ç–µ—Å—Ç-–∫–µ–π—Å—ã</h5>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="selectAll">
                        <label class="form-check-label" for="selectAll">
                            –í—ã–±—Ä–∞—Ç—å –≤—Å–µ
                        </label>
                    </div>
                </div>
                <div class="card-body" style="max-height: 600px; overflow-y: auto;">
                    {% if cases %}
                    <div class="list-group">
                        {% for case in cases %}
                        <div class="list-group-item list-group-item-action case-item" 
                             data-case-id="{{ case.id }}" 
                             data-proj-pk="{{ project.pk }}"
                             data-title="{{ case.title }}"
                             data-text="{{ case.text }}"
                             data-status="{{ case.status }}"
                             data-author="{{ case.author.username }}"
                             data-date="{{ case.published_date|date:'d.m.Y H:i' }}"
                             style="cursor: pointer;">
                            <div class="form-check d-flex align-items-start">
                                <input class="form-check-input case-checkbox me-3 mt-1" 
                                       type="checkbox" 
                                       value="{{ case.id }}" 
                                       id="case_{{ case.id }}" 
                                       onclick="event.stopPropagation();">
                                <div class="flex-grow-1">
                                    <h6 class="mb-1">{{ case.title }}</h6>
                                    <p class="mb-1">{{ case.text|truncatewords:20 }}</p>
                                    <small class="text-reset">
                                        {% if case.status == 'draft' %}
                                            <span class="badge bg-secondary status-badge" data-status="draft">{{ case.get_status_display }}</span>
                                        {% elif case.status == 'on_review' %}
                                            <span class="badge bg-warning text-dark status-badge" data-status="on_review">{{ case.get_status_display }}</span>
                                        {% elif case.status == 'actual' %}
                                            <span class="badge bg-success status-badge" data-status="actual">{{ case.get_status_display }}</span>
                                        {% elif case.status == 'correction_needed' %}
                                            <span class="badge bg-info text-dark status-badge" data-status="correction_needed">{{ case.get_status_display }}</span>
                                        {% else %}
                                            <span class="badge bg-secondary status-badge" data-status="draft">{{ case.get_status_display }}</span>
                                        {% endif %}
                                        | {{ case.author.username }} | {{ case.published_date|date:"d.m.Y H:i" }}
                                    </small>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-muted">–í –ø—Ä–æ–µ–∫—Ç–µ –ø–æ–∫–∞ –Ω–µ—Ç —Ç–µ—Å—Ç-–∫–µ–π—Å–æ–≤.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –¥–µ—Ç–∞–ª–∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∫–µ–π—Å–∞ -->
        <div class="col-md-7">
            <div id="caseDetailPane" class="card">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –∫–µ–π—Å–µ</h5>
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" id="editCaseBtn" class="btn btn-outline-primary" style="display: none;" data-bs-toggle="modal" data-bs-target="#editCaseModal">
                            ‚úé –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                        </button>
                        <button type="button" id="changeStatusBtn" class="btn btn-outline-warning" style="display: none;" data-bs-toggle="modal" data-bs-target="#statusModal">
                            ‚ü≥ –°—Ç–∞—Ç—É—Å
                        </button>
                        <button type="button" id="deleteCaseBtn" class="btn btn-outline-danger" style="display: none;">
                            üóë –£–¥–∞–ª–∏—Ç—å
                        </button>
                    </div>
                </div>
                <div class="card-body" id="caseDetailContent">
                    <p class="text-muted">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ—Å—Ç-–∫–µ–π—Å —Å–ª–µ–≤–∞, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –¥–µ—Ç–∞–ª–∏.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø—É—Å–∫–∞ -->
<div class="modal fade" id="launchModal" tabindex="-1" aria-labelledby="launchModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="launchModalLabel">–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∑–∞–ø—É—Å–∫</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="launchForm" method="post" action="">
                {% csrf_token %}
                <div class="modal-body">
                    {{form.as_p}}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-success" id="createLaunchBtn" disabled>
                        –°–æ–∑–¥–∞—Ç—å –∑–∞–ø—É—Å–∫ —Å <span id="selectedCount">0</span> –∫–µ–π—Å–∞–º–∏
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–µ–π—Å–∞ -->
<div class="modal fade" id="caseModal" tabindex="-1" aria-labelledby="caseModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="caseModalLabel">–°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç-–∫–µ–π—Å</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="caseForm" method="post" action="{% url 'case_new' proj_pk=project.pk %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="case_title_field" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                        <input type="text" class="form-control" id="case_title_field" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label for="case_text_field" class="form-label">–°—Ü–µ–Ω–∞—Ä–∏–π</label>
                        <textarea class="form-control" id="case_text_field" name="text" rows="6" required></textarea>
                    </div>
                    <input type="hidden" name="author" value="{{ request.user.id }}">
                    <input type="hidden" name="project" value="{{ project.id }}">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å –∫–µ–π—Å</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–µ–π—Å–∞ -->
<div class="modal fade" id="editCaseModal" tabindex="-1" aria-labelledby="editCaseModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editCaseModalLabel">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–µ—Å—Ç-–∫–µ–π—Å</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editCaseForm" method="post">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="id_edit_title" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                        <input type="text" class="form-control" id="id_edit_title" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label for="id_edit_text" class="form-label">–°—Ü–µ–Ω–∞—Ä–∏–π</label>
                        <textarea class="form-control" id="id_edit_text" name="text" rows="6" required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Å–º–µ–Ω—ã —Å—Ç–∞—Ç—É—Å–∞ -->
<div class="modal fade" id="statusModal" tabindex="-1" aria-labelledby="statusModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="statusModalLabel">–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∫–µ–π—Å–∞</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="statusForm" method="post">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="statusSelect" class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å</label>
                        <select class="form-select" id="statusSelect" name="status" required>
                            <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ç—É—Å --</option>
                            <option value="draft">–ß–µ—Ä–Ω–æ–≤–∏–∫</option>
                            <option value="on_review">–ù–∞ —Ä–µ–≤—å—é</option>
                            <option value="actual">–ê–∫—Ç—É–∞–ª—å–Ω—ã–π</option>
                            <option value="correction_needed">–¢—Ä–µ–±—É–µ—Ç –¥–æ—Ä–∞–±–æ—Ç–∫–∏</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-primary" id="saveStatusBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // –û—Å–Ω–æ–≤–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã DOM
    const selectAllCheckbox = document.getElementById('selectAll');
    const caseCheckboxes = document.querySelectorAll('.case-checkbox');
    const selectedCountSpan = document.getElementById('selectedCount');
    const createLaunchBtn = document.getElementById('createLaunchBtn');
    const caseIdsField = document.getElementById('id_case_ids');
    const launchForm = document.getElementById('launchForm');
    
    const caseItems = document.querySelectorAll('.case-item');
    const caseDetailPane = document.getElementById('caseDetailPane');
    const caseDetailContent = document.getElementById('caseDetailContent');
    
    const editCaseBtn = document.getElementById('editCaseBtn');
    const changeStatusBtn = document.getElementById('changeStatusBtn');
    const deleteCaseBtn = document.getElementById('deleteCaseBtn');
    
    const statusForm = document.getElementById('statusForm');
    const statusSelect = document.getElementById('statusSelect');
    const saveStatusBtn = document.getElementById('saveStatusBtn');
    
    const caseForm = document.getElementById('caseForm');
    const editCaseForm = document.getElementById('editCaseForm');
    
    // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
    let selectedCaseId = null;
    let selectedProjPk = null;
    
    // –¶–≤–µ—Ç–∞ —Å—Ç–∞—Ç—É—Å–æ–≤
    const statusColors = {
        'draft': 'secondary',
        'on_review': 'warning',
        'actual': 'success',
        'correction_needed': 'info'
    };
    
    const statusDisplay = {
        'draft': '–ß–µ—Ä–Ω–æ–≤–∏–∫',
        'on_review': '–ù–∞ —Ä–µ–≤—å—é',
        'actual': '–ê–∫—Ç—É–∞–ª—å–Ω—ã–π',
        'correction_needed': '–¢—Ä–µ–±—É–µ—Ç –¥–æ—Ä–∞–±–æ—Ç–∫–∏'
    };

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –ø–µ—Ä–µ–Ω–æ—Å–æ–≤ —Å—Ç—Ä–æ–∫
    function formatText(text, defaultValue = '–ù–µ —É–∫–∞–∑–∞–Ω–æ') {
        if (!text || text.trim() === '') return defaultValue;
        return text.replace(/\n/g, '<br>');
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ–±—ã—á–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
    function safeDisplay(text, defaultValue = '–ù–µ —É–∫–∞–∑–∞–Ω–æ') {
        if (!text || text.trim() === '') return defaultValue;
        return text;
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–µ—Ç–∞–ª–µ–π –∫–µ–π—Å–∞
    function showCaseDetails(caseItem) {
        const caseId = caseItem.dataset.caseId;
        const projPk = caseItem.dataset.projPk;
        const title = safeDisplay(caseItem.dataset.title);
        const text = formatText(caseItem.dataset.text);
        const status = safeDisplay(caseItem.dataset.status, 'draft');
        const author = safeDisplay(caseItem.dataset.author);
        const date = safeDisplay(caseItem.dataset.date);
        
        selectedCaseId = caseId;
        selectedProjPk = projPk;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø–∞–Ω–µ–ª–∏ –¥–µ—Ç–∞–ª–µ–π
        caseDetailContent.innerHTML = `
            <input type="hidden" name="current_case_id" value="${caseId}">
            <h4>${title}</h4>
            <p><span class="badge bg-${statusColors[status]} status-badge">${statusDisplay[status]}</span></p>
            <hr />
            
            <h6>–°—Ü–µ–Ω–∞—Ä–∏–π</h6>
            <div class="scenario-text mb-3">${text}</div>
            
            <div class="row mt-4">
                <div class="col-md-6">
                    <h6>–ê–≤—Ç–æ—Ä</h6>
                    <p class="text">${author}</p>
                </div>
                <div class="col-md-6">
                    <h6>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</h6>
                    <p class="text">${date}</p>
                </div>
            </div>
        `;

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π
        editCaseBtn.style.display = 'inline-block';
        changeStatusBtn.style.display = 'inline-block';
        deleteCaseBtn.style.display = 'inline-block';
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –∫–µ–π—Å –≤ localStorage
        localStorage.setItem('selectedCase_' + window.location.pathname, caseId);
        
        // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç
        caseItems.forEach(item => item.classList.remove('active'));
        caseItem.classList.add('active');
        
        // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É —ç–ª–µ–º–µ–Ω—Ç—É
        caseItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è –¥–µ—Ç–∞–ª–µ–π –∫–µ–π—Å–∞
    function hideCaseDetails() {
        caseDetailContent.innerHTML = '<p class="text-muted">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ—Å—Ç-–∫–µ–π—Å —Å–ª–µ–≤–∞, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –¥–µ—Ç–∞–ª–∏.</p>';
        editCaseBtn.style.display = 'none';
        changeStatusBtn.style.display = 'none';
        deleteCaseBtn.style.display = 'none';
        
        // –£–±–∏—Ä–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É
        caseItems.forEach(item => item.classList.remove('active'));
        
        // –û—á–∏—â–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä
        localStorage.removeItem('selectedCase_' + window.location.pathname);
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ –∫–µ–π—Å
    caseItems.forEach(item => {
        item.addEventListener('click', function(e) {
            if (!e.target.closest('.form-check-input')) {
                showCaseDetails(this);
            }
        });
    });
    
    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∫–µ–π—Å–æ–≤
    function updateSelectedCount() {
        const selectedCases = Array.from(caseCheckboxes).filter(cb => cb.checked);
        const count = selectedCases.length;
        
        selectedCountSpan.textContent = count;
        document.getElementById('selectedCountHeader').textContent = count;
        createLaunchBtn.disabled = count === 0;
        
        const caseIds = selectedCases.map(cb => cb.value).join(',');
        if (caseIdsField) {
            caseIdsField.value = caseIds;
        }
        
        selectAllCheckbox.checked = count === caseCheckboxes.length && count > 0;
        selectAllCheckbox.indeterminate = count > 0 && count < caseCheckboxes.length;
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è "–í—ã–±—Ä–∞—Ç—å –≤—Å–µ"
    selectAllCheckbox.addEventListener('change', function() {
        caseCheckboxes.forEach(cb => {
            cb.checked = this.checked;
        });
        updateSelectedCount();
    });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —á–µ–∫–±–æ–∫—Å–æ–≤
    caseCheckboxes.forEach(cb => {
        cb.addEventListener('change', function() {
            updateSelectedCount();
        });
    });
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—á–µ—Ç—á–∏–∫–∞
    updateSelectedCount();
    
    // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∫–µ–π—Å–∞ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
    const savedCaseId = localStorage.getItem('selectedCase_' + window.location.pathname);
    if (savedCaseId) {
        const savedCaseItem = document.querySelector(`.case-item[data-case-id="${savedCaseId}"]`);
        if (savedCaseItem) {
            showCaseDetails(savedCaseItem);
        }
    }
    
    // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø—É—Å–∫–∞
    if (launchForm) {
        launchForm.addEventListener('submit', function(e) {
            const selectedCount = parseInt(selectedCountSpan.textContent);
            
            if (selectedCount === 0) {
                e.preventDefault();
                alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ç–µ—Å—Ç-–∫–µ–π—Å');
                return false;
            }
            
            if (!confirm(`–°–æ–∑–¥–∞—Ç—å –∑–∞–ø—É—Å–∫ —Å ${selectedCount} –∫–µ–π—Å–∞–º–∏?`)) {
                e.preventDefault();
                return false;
            }
        });
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–º–µ–Ω—ã —Å—Ç–∞—Ç—É—Å–∞
    saveStatusBtn.addEventListener('click', function(e) {
        e.preventDefault();
        
        if (!selectedCaseId || !selectedProjPk) {
            alert('–í—ã–±–µ—Ä–∏—Ç–µ –∫–µ–π—Å');
            return;
        }
        
        const newStatus = statusSelect.value;
        if (!newStatus) {
            alert('–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ç—É—Å');
            return;
        }
        
        // –í—ã–ø–æ–ª–Ω—è–µ–º AJAX –∑–∞–ø—Ä–æ—Å –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
        fetch(`/proj/${selectedProjPk}/case/${selectedCaseId}/edit/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: `status=${newStatus}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // –û–±–Ω–æ–≤–ª—è–µ–º data-–∞—Ç—Ä–∏–±—É—Ç—ã —ç–ª–µ–º–µ–Ω—Ç–∞ —Å–ø–∏—Å–∫–∞
                const caseElement = document.querySelector(`.case-item[data-case-id="${selectedCaseId}"]`);
                if (caseElement) {
                    caseElement.dataset.status = newStatus;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –±–µ–π–¥–∂ –≤ —Å–ø–∏—Å–∫–µ
                    const badgeEl = caseElement.querySelector('.badge');
                    badgeEl.textContent = data.status_display || statusDisplay[newStatus];
                    badgeEl.className = `badge bg-${statusColors[newStatus]} status-badge`;
                    badgeEl.dataset.status = newStatus;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–∞–Ω–µ–ª—å –¥–µ—Ç–∞–ª–µ–π
                    showCaseDetails(caseElement);
                }
                
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å
                const modal = bootstrap.Modal.getInstance(document.getElementById('statusModal'));
                modal.hide();
                
                showAlert('–°—Ç–∞—Ç—É—Å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª—ë–Ω', 'success');
            } else {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞');
        });
    });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —É–¥–∞–ª–µ–Ω–∏—è –∫–µ–π—Å–∞
    deleteCaseBtn.addEventListener('click', function() {
        if (!selectedCaseId || !selectedProjPk) return;
        
        if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∫–µ–π—Å?')) {
            window.location.href = `/proj/${selectedProjPk}/case/${selectedCaseId}/delete/`;
        }
    });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª–∏ —Å–æ–∑–¥–∞–Ω–∏—è –∫–µ–π—Å–∞ - –æ—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
    const caseModalEl = document.getElementById('caseModal');
    if (caseModalEl) {
        caseModalEl.addEventListener('show.bs.modal', function() {
            const titleField = document.getElementById('case_title_field');
            const textField = document.getElementById('case_text_field');
            
            if (titleField) titleField.value = '';
            if (textField) textField.value = '';
        });
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º—ã —Å–æ–∑–¥–∞–Ω–∏—è –∫–µ–π—Å–∞
    if (caseForm) {
        caseForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const titleField = document.getElementById('case_title_field');
            const textField = document.getElementById('case_text_field');
            const authorField = document.querySelector('input[name="author"]');
            const projectField = document.querySelector('input[name="project"]');
            const csrfField = document.querySelector('[name=csrfmiddlewaretoken]');
            
            if (!titleField || !textField) {
                alert('–û—à–∏–±–∫–∞: –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –ø–æ–ª—è —Ñ–æ—Ä–º—ã');
                return;
            }
            
            const title = titleField.value.trim();
            const text = textField.value;
            
            if (!title) {
                alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–µ–π—Å–∞');
                titleField.focus();
                return;
            }
            
            if (!text) {
                alert('–í–≤–µ–¥–∏—Ç–µ —Å—Ü–µ–Ω–∞—Ä–∏–π –∫–µ–π—Å–∞');
                textField.focus();
                return;
            }
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º—É —á–µ—Ä–µ–∑ AJAX
            const formData = new FormData();
            formData.append('title', title);
            formData.append('text', text);
            if (authorField) formData.append('author', authorField.value);
            if (projectField) formData.append('project', projectField.value);
            if (csrfField) formData.append('csrfmiddlewaretoken', csrfField.value);
            
            fetch(this.action, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–µ–π—Å–∞: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–µ–π—Å–∞');
            });
        });
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–µ–π—Å–∞
    if (editCaseForm) {
        editCaseForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const title = document.getElementById('id_edit_title').value.trim();
            const text = document.getElementById('id_edit_text').value;
            
            if (!title) {
                alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–µ–π—Å–∞');
                return;
            }
            
            if (!text) {
                alert('–í–≤–µ–¥–∏—Ç–µ —Å—Ü–µ–Ω–∞—Ä–∏–π –∫–µ–π—Å–∞');
                return;
            }
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º action —Ñ–æ—Ä–º—ã
            editCaseForm.action = `/proj/${selectedProjPk}/case/${selectedCaseId}/edit/`;
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º—É —á–µ—Ä–µ–∑ AJAX
            const formData = new FormData();
            formData.append('title', title);
            formData.append('text', text);
            formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
            
            fetch(this.action, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º data-–∞—Ç—Ä–∏–±—É—Ç—ã —ç–ª–µ–º–µ–Ω—Ç–∞ —Å–ø–∏—Å–∫–∞
                    const caseElement = document.querySelector(`.case-item[data-case-id="${selectedCaseId}"]`);
                    if (caseElement) {
                        caseElement.dataset.title = title;
                        caseElement.dataset.text = text;
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
                        caseElement.querySelector('h6').textContent = title;
                        caseElement.querySelector('p').textContent = text.substring(0, 100) + (text.length > 100 ? '...' : '');
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–∞–Ω–µ–ª—å –¥–µ—Ç–∞–ª–µ–π
                        showCaseDetails(caseElement);
                    }
                    
                    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å
                    const modal = bootstrap.Modal.getInstance(document.getElementById('editCaseModal'));
                    modal.hide();
                    
                    showAlert('–ö–µ–π—Å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª—ë–Ω', 'success');
                } else {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –∫–µ–π—Å–∞: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –∫–µ–π—Å–∞');
            });
        });
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    function showAlert(message, type) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 1060; min-width: 300px;';
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(alertDiv);
        setTimeout(() => { 
            if (alertDiv.parentNode) {
                alertDiv.remove(); 
            }
        }, 5000);
    }
    
    // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∫–Ω–æ–ø–∫—É
    editCaseBtn.addEventListener('click', function(e) {
        e.preventDefault();
        const caseElement = document.querySelector(`.case-item[data-case-id="${selectedCaseId}"]`);
        if (caseElement) {
            document.getElementById('id_edit_title').value = caseElement.dataset.title;
            document.getElementById('id_edit_text').value = caseElement.dataset.text;
        }
    });
});
</script>

{% endblock %}