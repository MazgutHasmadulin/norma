{% extends 'norma/base.html' %}
{% load static %}

<style>
    .case-item.active {
        background-color: #0d6efd !important;
        color: white !important;
    }
    
    .case-item.active h6,
    .case-item.active p,
    .case-item.active small,
    .case-item.active .text-muted {
        color: white !important;
    }
    
    .case-item.active .badge {
        opacity: 0.9;
        color: white !important;
    }
    
    .case-item.active .form-check-label {
        color: white !important;
    }
</style>

{% block content %}
<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>–¢–µ—Å—Ç-–∫–µ–π—Å—ã –ø—Ä–æ–µ–∫—Ç–∞: {{ project.title }}</h1>
        <div>
            <a href="{% url 'proj_dashboard' pk=project.pk %}" class="btn btn-secondary">
                ‚Üê –ù–∞–∑–∞–¥ –∫ –ø—Ä–æ–µ–∫—Ç—É
            </a>
            <button type="button" class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#caseModal">
                + –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç-–∫–µ–π—Å
            </button>
            <button type="button" class="btn btn-success" id="createLaunchBtnOpen" data-bs-toggle="modal" data-bs-target="#launchModal">
                + –°–æ–∑–¥–∞—Ç—å –∑–∞–ø—É—Å–∫ (<span id="selectedCountHeader">0</span>)
            </button>
        </div>
    </div>

    <div class="row">
        <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–Ω–∞: –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–µ–π—Å—ã -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ç–µ—Å—Ç-–∫–µ–π—Å—ã</h5>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="selectAll">
                        <label class="form-check-label" for="selectAll">
                            –í—ã–±—Ä–∞—Ç—å –≤—Å–µ
                        </label>
                    </div>
                </div>
                <div class="card-body" style="max-height: 600px; overflow-y: auto;">
                    {% if cases %}
                    <div class="list-group">
                        {% for case in cases %}
                        <div class="list-group-item list-group-item-action case-item" data-case-id="{{ case.id }}" data-proj-pk="{{ project.pk }}" style="cursor: pointer;">
                            <div class="form-check d-flex align-items-start">
                                <input class="form-check-input case-checkbox me-3 mt-1" 
                                       type="checkbox" 
                                       value="{{ case.id }}" 
                                       id="case_{{ case.id }}" 
                                       onclick="event.stopPropagation();">
                                <div class="flex-grow-1">
                                    <h6 class="mb-1">{{ case.title }}</h6>
                                    <p class="mb-1 text-muted small">{{ case.text|truncatewords:20 }}</p>
                                    <small class="text-muted">
                                        {% if case.status == 'draft' %}
                                            <span class="badge bg-secondary" data-status="draft">{{ case.get_status_display }}</span>
                                        {% elif case.status == 'on_review' %}
                                            <span class="badge bg-warning text-dark" data-status="on_review">{{ case.get_status_display }}</span>
                                        {% elif case.status == 'actual' %}
                                            <span class="badge bg-success" data-status="actual">{{ case.get_status_display }}</span>
                                        {% elif case.status == 'correction_needed' %}
                                            <span class="badge bg-info text-dark" data-status="correction_needed">{{ case.get_status_display }}</span>
                                        {% else %}
                                            <span class="badge bg-secondary" data-status="draft">{{ case.get_status_display }}</span>
                                        {% endif %}
                                        | {{ case.author.username }} | {{ case.created_date|date:"d.m.Y" }}
                                    </small>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-muted">–í –ø—Ä–æ–µ–∫—Ç–µ –ø–æ–∫–∞ –Ω–µ—Ç —Ç–µ—Å—Ç-–∫–µ–π—Å–æ–≤.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–Ω–∞: –¥–µ—Ç–∞–ª–∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∫–µ–π—Å–∞ -->
        <div class="col-md-6">
            <div class="card" id="caseDetailsCard" style="display: none;">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h5 class="mb-0" id="caseDetailTitle">–í—ã–±–µ—Ä–∏—Ç–µ –∫–µ–π—Å</h5>
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" id="editCaseBtn" class="btn btn-outline-primary" style="display: none;" data-bs-toggle="modal" data-bs-target="#editCaseModal">
                            ‚úé –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                        </button>
                        <button type="button" id="changeStatusBtn" class="btn btn-outline-warning" style="display: none;" data-bs-toggle="modal" data-bs-target="#statusModal">
                            ‚ü≥ –°—Ç–∞—Ç—É—Å
                        </button>
                        <button type="button" id="deleteCaseBtn" class="btn btn-outline-danger" style="display: none;">
                            üóë –£–¥–∞–ª–∏—Ç—å
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label text-muted">–°—Ç–∞—Ç—É—Å</label>
                        <div>
                            <span id="caseDetailStatus" class="badge bg-secondary">‚Äî</span>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label text-muted">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                        <p id="caseDetailText" class="text-dark">‚Äî</p>
                    </div>

                    <div class="mb-3">
                        <label class="form-label text-muted">–ê–≤—Ç–æ—Ä</label>
                        <p id="caseDetailAuthor" class="text-dark">‚Äî</p>
                    </div>

                    <div class="mb-3">
                        <label class="form-label text-muted">–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</label>
                        <p id="caseDetailDate" class="text-dark">‚Äî</p>
                    </div>
                </div>
            </div>

            <div class="alert alert-info" id="noSelectionAlert" role="alert">
                <p class="mb-0">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ—Å—Ç-–∫–µ–π—Å –∏–∑ —Å–ø–∏—Å–∫–∞ —Å–ª–µ–≤–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–µ—Ç–∞–ª–µ–π</p>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø—É—Å–∫–∞ -->
<div class="modal fade" id="launchModal" tabindex="-1" aria-labelledby="launchModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="launchModalLabel">–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∑–∞–ø—É—Å–∫</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="launchForm" method="post" action="">
                {% csrf_token %}
                <div class="modal-body">
                    {{form.as_p}}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-success" id="createLaunchBtn" disabled>
                        –°–æ–∑–¥–∞—Ç—å –∑–∞–ø—É—Å–∫ —Å <span id="selectedCount">0</span> –∫–µ–π—Å–∞–º–∏
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–µ–π—Å–∞ -->
<div class="modal fade" id="caseModal" tabindex="-1" aria-labelledby="caseModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="caseModalLabel">–°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç-–∫–µ–π—Å</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="caseForm" method="post" action="{% url 'case_new' proj_pk=project.pk %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="case_title_field" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                        <input type="text" class="form-control" id="case_title_field" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label for="case_text_field" class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                        <textarea class="form-control" id="case_text_field" name="text" rows="4" required></textarea>
                    </div>
                    <input type="hidden" name="author" value="{{ request.user.id }}">
                    <input type="hidden" name="project" value="{{ project.id }}">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å –∫–µ–π—Å</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–µ–π—Å–∞ -->
<div class="modal fade" id="editCaseModal" tabindex="-1" aria-labelledby="editCaseModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editCaseModalLabel">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–µ—Å—Ç-–∫–µ–π—Å</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editCaseForm" method="post">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="id_edit_title" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                        <input type="text" class="form-control" id="id_edit_title" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label for="id_edit_text" class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                        <textarea class="form-control" id="id_edit_text" name="text" rows="4" required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Å–º–µ–Ω—ã —Å—Ç–∞—Ç—É—Å–∞ -->
<div class="modal fade" id="statusModal" tabindex="-1" aria-labelledby="statusModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="statusModalLabel">–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∫–µ–π—Å–∞</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="statusForm" method="post">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="statusSelect" class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å</label>
                        <select class="form-select" id="statusSelect" name="status" required>
                            <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ç—É—Å --</option>
                            <option value="draft">–ß–µ—Ä–Ω–æ–≤–∏–∫</option>
                            <option value="on_review">–ù–∞ —Ä–µ–≤—å—é</option>
                            <option value="actual">–ê–∫—Ç—É–∞–ª—å–Ω—ã–π</option>
                            <option value="correction_needed">–¢—Ä–µ–±—É–µ—Ç –¥–æ—Ä–∞–±–æ—Ç–∫–∏</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-primary" id="saveStatusBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const selectAllCheckbox = document.getElementById('selectAll');
    const caseCheckboxes = document.querySelectorAll('.case-checkbox');
    const selectedCountSpan = document.getElementById('selectedCount');
    const createLaunchBtn = document.getElementById('createLaunchBtn');
    const caseIdsField = document.getElementById('id_case_ids');
    const launchForm = document.getElementById('launchForm');
    
    const caseItems = document.querySelectorAll('.case-item');
    const caseDetailsCard = document.getElementById('caseDetailsCard');
    const noSelectionAlert = document.getElementById('noSelectionAlert');
    
    const editCaseBtn = document.getElementById('editCaseBtn');
    const changeStatusBtn = document.getElementById('changeStatusBtn');
    const deleteCaseBtn = document.getElementById('deleteCaseBtn');
    
    const statusForm = document.getElementById('statusForm');
    const statusSelect = document.getElementById('statusSelect');
    const saveStatusBtn = document.getElementById('saveStatusBtn');
    
    const caseForm = document.getElementById('caseForm');
    const editCaseForm = document.getElementById('editCaseForm');
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ–æ—Ä–º–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    if (!caseForm) {
        console.error('Case form not found');
        return;
    }
    
    let selectedCaseId = null;
    let selectedProjPk = null;
    let casesList = {};
    
    const statusMap = {
        'draft': '–ß–µ—Ä–Ω–æ–≤–∏–∫',
        'on_review': '–ù–∞ —Ä–µ–≤—å—é',
        'actual': '–ê–∫—Ç—É–∞–ª—å–Ω—ã–π',
        'correction_needed': '–¢—Ä–µ–±—É–µ—Ç –¥–æ—Ä–∞–±–æ—Ç–∫–∏'
    };
    
    const statusColors = {
        'draft': 'bg-secondary',
        'on_review': 'bg-warning text-dark',
        'actual': 'bg-success',
        'correction_needed': 'bg-info text-dark'
    };
    
    // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤—Å–µ—Ö –∫–µ–π—Å–æ–≤
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è HTML-—Å—É—â–Ω–æ—Å—Ç–µ–π
    function decodeHtmlEntities(text) {
        const textarea = document.createElement('textarea');
        textarea.innerHTML = text;
        return textarea.value;
    }
    
    caseItems.forEach(item => {
        const caseId = item.dataset.caseId;
        const projPk = item.dataset.projPk;
        const statusEl = item.querySelector('.badge');
        const statusKey = statusEl.dataset.status;
        const titleEl = item.querySelector('h6');
        const textEl = item.querySelector('p');
        
        casesList[caseId] = {
            id: caseId,
            proj_pk: projPk,
            title: decodeHtmlEntities(titleEl.innerHTML),  // –î–µ–∫–æ–¥–∏—Ä—É–µ–º HTML-—Å—É—â–Ω–æ—Å—Ç–∏
            text: textEl.textContent,
            status: statusKey,
            status_display: statusEl.textContent,
            author: item.querySelector('small').textContent.split('|')[1]?.trim() || 'Unknown',
            date: item.querySelector('small').textContent.split('|')[2]?.trim() || '‚Äî',
            element: item
        };
    });
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–µ—Ç–∞–ª–µ–π –∫–µ–π—Å–∞
    function showCaseDetails(caseId) {
        const caseData = casesList[caseId];
        if (!caseData) return;
        
        selectedCaseId = caseId;
        selectedProjPk = caseData.proj_pk;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø–∞–Ω–µ–ª–∏ –¥–µ—Ç–∞–ª–µ–π
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º textContent –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è (—Å—É—â–Ω–æ—Å—Ç–∏ —É–∂–µ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω—ã)
        document.getElementById('caseDetailTitle').textContent = caseData.title;
        // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º \n –≤ <br> –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∞–±–∑–∞—Ü–µ–≤
        const formattedText = caseData.text.replace(/\n/g, '<br>');
        document.getElementById('caseDetailText').innerHTML = formattedText;
        document.getElementById('caseDetailAuthor').textContent = caseData.author;
        document.getElementById('caseDetailDate').textContent = caseData.date;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Ä–∞—Å–∫—Ä–∞—Å–∫–æ–π
        const statusBadge = document.getElementById('caseDetailStatus');
        statusBadge.textContent = caseData.status_display;
        statusBadge.className = 'badge ' + statusColors[caseData.status];
        statusSelect.value = caseData.status;
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞—Ä—Ç—É –¥–µ—Ç–∞–ª–µ–π
        caseDetailsCard.style.display = 'block';
        noSelectionAlert.style.display = 'none';
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π
        editCaseBtn.style.display = 'inline-block';
        // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∫–Ω–æ–ø–∫—É
        editCaseBtn.onclick = function(e) {
            e.preventDefault();
            document.getElementById('id_edit_title').value = caseData.title;
            document.getElementById('id_edit_text').value = caseData.text;
            editCaseForm.action = `/proj/${selectedProjPk}/case/${caseId}/edit/`;
        };
        changeStatusBtn.style.display = 'inline-block';
        deleteCaseBtn.style.display = 'inline-block';
        
        // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç
        caseItems.forEach(item => item.classList.remove('active'));
        caseData.element.classList.add('active');
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ –∫–µ–π—Å
    caseItems.forEach(item => {
        item.addEventListener('click', function(e) {
            if (!e.target.closest('.form-check-input')) {
                showCaseDetails(this.dataset.caseId);
            }
        });
    });
    
    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∫–µ–π—Å–æ–≤
    function updateSelectedCount() {
        const selectedCases = Array.from(caseCheckboxes).filter(cb => cb.checked);
        const count = selectedCases.length;
        
        selectedCountSpan.textContent = count;
        document.getElementById('selectedCountHeader').textContent = count;
        createLaunchBtn.disabled = count === 0;
        
        const caseIds = selectedCases.map(cb => cb.value).join(',');
        caseIdsField.value = caseIds;
        
        selectAllCheckbox.checked = count === caseCheckboxes.length && count > 0;
        selectAllCheckbox.indeterminate = count > 0 && count < caseCheckboxes.length;
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è "–í—ã–±—Ä–∞—Ç—å –≤—Å–µ"
    selectAllCheckbox.addEventListener('change', function() {
        caseCheckboxes.forEach(cb => {
            cb.checked = this.checked;
        });
        updateSelectedCount();
    });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —á–µ–∫–±–æ–∫—Å–æ–≤
    caseCheckboxes.forEach(cb => {
        cb.addEventListener('change', function() {
            updateSelectedCount();
        });
    });
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—á–µ—Ç—á–∏–∫–∞
    updateSelectedCount();
    
    // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø—É—Å–∫–∞
    launchForm.addEventListener('submit', function(e) {
        const selectedCount = parseInt(selectedCountSpan.textContent);
        
        if (selectedCount === 0) {
            e.preventDefault();
            alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ç–µ—Å—Ç-–∫–µ–π—Å');
            return false;
        }
        
        if (!confirm(`–°–æ–∑–¥–∞—Ç—å –∑–∞–ø—É—Å–∫ —Å ${selectedCount} –∫–µ–π—Å–∞–º–∏?`)) {
            e.preventDefault();
            return false;
        }
    });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–º–µ–Ω—ã —Å—Ç–∞—Ç—É—Å–∞
    saveStatusBtn.addEventListener('click', function(e) {
        e.preventDefault();
        
        if (!selectedCaseId || !selectedProjPk) {
            alert('–í—ã–±–µ—Ä–∏—Ç–µ –∫–µ–π—Å');
            return;
        }
        
        const newStatus = statusSelect.value;
        if (!newStatus) {
            alert('–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ç—É—Å');
            return;
        }
        
        // –í—ã–ø–æ–ª–Ω—è–µ–º AJAX –∑–∞–ø—Ä–æ—Å –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
        fetch(`/proj/${selectedProjPk}/case/${selectedCaseId}/edit/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: `status=${newStatus}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∫–µ–π—Å–∞
                casesList[selectedCaseId].status = newStatus;
                casesList[selectedCaseId].status_display = data.status_display;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤ —Å–ø–∏—Å–∫–µ
                const caseElement = casesList[selectedCaseId].element;
                const badgeEl = caseElement.querySelector('.badge');
                badgeEl.textContent = data.status_display;
                badgeEl.className = 'badge ' + statusColors[newStatus];
                badgeEl.dataset.status = newStatus;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø–∞–Ω–µ–ª—å –¥–µ—Ç–∞–ª–µ–π
                showCaseDetails(selectedCaseId);
                
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å
                const modal = bootstrap.Modal.getInstance(document.getElementById('statusModal'));
                modal.hide();
            } else {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞');
        });
    });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —É–¥–∞–ª–µ–Ω–∏—è –∫–µ–π—Å–∞
    deleteCaseBtn.addEventListener('click', function() {
        if (!selectedCaseId || !selectedProjPk) return;
        
        if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∫–µ–π—Å?')) {
            window.location.href = `/proj/${selectedProjPk}/case/${selectedCaseId}/delete/`;
        }
    });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª–∏ —Å–æ–∑–¥–∞–Ω–∏—è –∫–µ–π—Å–∞ - –æ—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
    const caseModalEl = document.getElementById('caseModal');
    if (caseModalEl) {
        caseModalEl.addEventListener('show.bs.modal', function() {
            const titleField = document.getElementById('case_title_field');
            const textField = document.getElementById('case_text_field');
            
            console.log('Opening modal, title field:', titleField, 'text field:', textField);
            
            if (titleField) titleField.value = '';
            if (textField) textField.value = '';
        });
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º—ã —Å–æ–∑–¥–∞–Ω–∏—è –∫–µ–π—Å–∞
    caseForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // –ü–æ–ª—É—á–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –∏–∑ DOM –≤ –º–æ–º–µ–Ω—Ç submit'–∞
        const titleField = document.getElementById('case_title_field');
        const textField = document.getElementById('case_text_field');
        const authorField = document.querySelector('input[name="author"]');
        const projectField = document.querySelector('input[name="project"]');
        const csrfField = document.querySelector('[name=csrfmiddlewaretoken]');
        
        if (!titleField || !textField) {
            console.error('Form fields not found:', {titleField, textField});
            alert('–û—à–∏–±–∫–∞: –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –ø–æ–ª—è —Ñ–æ—Ä–º—ã');
            return;
        }
        
        const title = titleField.value.trim();
        const text = textField.value.trim();
        
        console.log('Before submit - Title:', title, 'Text:', text);
        
        if (!title) {
            alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–µ–π—Å–∞');
            titleField.focus();
            return;
        }
        
        if (!text) {
            alert('–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∫–µ–π—Å–∞');
            textField.focus();
            return;
        }
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º—É —á–µ—Ä–µ–∑ AJAX
        const formData = new FormData();
        formData.append('title', title);
        formData.append('text', text);
        if (authorField) formData.append('author', authorField.value);
        if (projectField) formData.append('project', projectField.value);
        if (csrfField) formData.append('csrfmiddlewaretoken', csrfField.value);
        
        console.log('Submitting form to:', this.action);
        
        fetch(this.action, {
            method: 'POST',
            body: formData
        })
        .then(response => {
            console.log('Response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('Response data:', data);
            if (data.success) {
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –ø–æ–∫–∞–∑–∞ –Ω–æ–≤–æ–≥–æ –∫–µ–π—Å–∞
                location.reload();
            } else {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–µ–π—Å–∞: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–µ–π—Å–∞');
        });
    });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–µ–π—Å–∞
    editCaseForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const title = document.getElementById('id_edit_title').value.trim();
        const text = document.getElementById('id_edit_text').value.trim();
        
        if (!title) {
            alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–µ–π—Å–∞');
            return;
        }
        
        if (!text) {
            alert('–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∫–µ–π—Å–∞');
            return;
        }
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º—É —á–µ—Ä–µ–∑ AJAX
        const formData = new FormData();
        formData.append('title', title);
        formData.append('text', text);
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        
        fetch(this.action, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∫–µ–π—Å–∞ –≤ –ø–∞–º—è—Ç–∏
                casesList[selectedCaseId].title = title;
                casesList[selectedCaseId].text = text;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
                const caseElement = casesList[selectedCaseId].element;
                caseElement.querySelector('h6').textContent = title;
                caseElement.querySelector('p').textContent = text;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø–∞–Ω–µ–ª—å –¥–µ—Ç–∞–ª–µ–π
                showCaseDetails(selectedCaseId);
                
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å
                const modal = bootstrap.Modal.getInstance(document.getElementById('editCaseModal'));
                modal.hide();
            } else {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –∫–µ–π—Å–∞: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –∫–µ–π—Å–∞');
        });
    });
});
</script>

{% endblock %}

