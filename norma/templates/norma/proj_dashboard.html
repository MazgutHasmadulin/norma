{% extends 'norma/base.html' %}

{% block content %}
<div class="container mt-4">
    <div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1>–ü—Ä–æ–µ–∫—Ç: {{ project.title }}</h1>
            <p class="text-muted mb-0">–î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: {{ project.last_update_date|date:"d.m.Y H:i" }}</p>
        </div>
        <div>
            <a href="{% url 'proj_list'%}" class="btn btn-secondary">
                ‚Üê –ö —Å–ø–∏—Å–∫—É –ø—Ä–æ–µ–∫—Ç–æ–≤
            </a>
            <button type="button" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#projEditModal">
                ‚úé –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–µ–∫—Ç
            </button>
            <button type="button" class="btn btn-danger ms-2" data-bs-toggle="modal" data-bs-target="#projDeleteModal">
                üóë –£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–µ–∫—Ç
            </button>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞ -->
    <div class="modal fade" id="projEditModal" tabindex="-1" aria-labelledby="projEditModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="projEditModalLabel">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–µ–∫—Ç</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="projEditForm" method="post" action="{% url 'proj_edit' pk=project.id %}">
                    {% csrf_token %}
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="proj_title" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞</label>
                            <input type="text" id="proj_title" name="title" class="form-control" value="{{ project.title }}" required maxlength="100">
                        </div>
                        <div class="mb-3">
                            <label for="proj_personel" class="form-label">–ü–µ—Ä—Å–æ–Ω–∞–ª / –∫–æ–Ω—Ç–∞–∫—Ç—ã</label>
                            <textarea id="proj_personel" name="personel" class="form-control" rows="2">{{ project.personel }}</textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                        <button type="submit" class="btn btn-primary" id="projSaveBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞ -->
    <div class="modal fade" id="projDeleteModal" tabindex="-1" aria-labelledby="projDeleteModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="projDeleteForm" method="post" action="{% url 'proj_delete' pk=project.id %}">
                    {% csrf_token %}
                    <div class="modal-header">
                        <h5 class="modal-title" id="projDeleteModalLabel">–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–µ–∫—Ç</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p>–î–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è –≤–≤–µ–¥–∏—Ç–µ —Å–ª–æ–≤–æ <strong>–£–¥–∞–ª–∏—Ç—å</strong> –≤ –ø–æ–ª–µ –Ω–∏–∂–µ.</p>
                        <div class="mb-3">
                            <input type="text" id="projDeleteConfirmInput" name="confirm_text" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ '–£–¥–∞–ª–∏—Ç—å'">
                            <div class="invalid-feedback" id="projDeleteFeedback">–ù—É–∂–Ω–æ –≤–≤–µ—Å—Ç–∏ —Ç–æ—á–Ω–æ–µ —Å–ª–æ–≤–æ ¬´–£–¥–∞–ª–∏—Ç—å¬ª.</div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                        <button type="submit" class="btn btn-danger" id="projDeleteBtn" disabled>–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–µ–∫—Ç</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">–ó–∞–ø—É—Å–∫–∏: {{ launches.count }}</h5>
                    
                    <div>
                        <a href="{% url 'launches_list' proj_pk=project.id %}" class="btn btn-outline-secondary btn-sm">
                            –í—Å–µ –∑–∞–ø—É—Å–∫–∏
                        </a>
                        <a href="{% url 'cases_list' pk=project.id %}" class="btn btn-primary btn-sm ms-2">
                            –°–æ–∑–¥–∞—Ç—å –∑–∞–ø—É—Å–∫
                        </a>
                    </div>
                </div>
                <div class="card-body" style="max-height: 500px; overflow-y: auto;">
                    {% for launch in launches %}
                    <div class="d-flex justify-content-between align-items-center border-bottom py-2">
                        <div>
                            <a href="{% url 'launch_detail' launch.id %}" class="text-decoration-none">
                                {{ launch.title }}
                            </a>
                            <small class="d-block text-muted">
                                –°–æ–∑–¥–∞–Ω: {{ launch.created_date|date:"d.m.Y" }} | 
                                –ö–µ–π—Å–æ–≤: {{ launch.test_results.count }}
                            </small>
                        </div>
                        <a href="{% url 'launch_detail' launch.id %}" class="btn btn-outline-primary btn-sm">
                            –û—Ç–∫—Ä—ã—Ç—å
                        </a>
                    </div>
                    {% empty %}
                    <p class="text-muted">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø—É—Å–∫–æ–≤</p>
                    {% endfor %}
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">–í—Å–µ–≥–æ –∫–µ–π—Å–æ–≤: {{ total_cases }}</h5>
                    
                    <a href="{% url 'cases_list' pk=project.id %}" class="btn btn-primary btn-sm">
                        –û—Ç–∫—Ä—ã—Ç—å —Å–ø–∏—Å–æ–∫ –∫–µ–π—Å–æ–≤
                    </a>
                </div>
                <div class="card-body">
                    {% if total_cases > 0 %}
                    <div class="mb-3">
                        <!-- –ß–µ—Ä–Ω–æ–≤–∏–∫ -->
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="badge bg-secondary">–ß–µ—Ä–Ω–æ–≤–∏–∫</span>
                            <span>{{ draft_cases }} ({{ draft_percentage }}%)</span>
                        </div>
                        <div class="progress mb-3" style="height: 6px;">
                            {# stylelint-disable #}
                            <div class="progress-bar bg-secondary" role="progressbar" aria-valuenow="{{ draft_percentage }}" aria-valuemin="0" aria-valuemax="100" style="width: {{ draft_percentage|default:0 }}%;"></div>
                            {# stylelint-enable #}
                        </div>

                        <!-- –ù–∞ —Ä–µ–≤—å—é -->
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="badge bg-warning text-dark">–ù–∞ —Ä–µ–≤—å—é</span>
                            <span>{{ review_cases }} ({{ review_percentage }}%)</span>
                        </div>
                        <div class="progress mb-3" style="height: 6px;">
                            {# stylelint-disable #}
                            <div class="progress-bar bg-warning" role="progressbar" aria-valuenow="{{ review_percentage }}" aria-valuemin="0" aria-valuemax="100" style="width: {{ review_percentage|default:0 }}%;"></div>
                            {# stylelint-enable #}
                        </div>

                        <!-- –ê–∫—Ç—É–∞–ª—å–Ω—ã–µ -->
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="badge bg-success">–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ</span>
                            <span>{{ actual_cases }} ({{ actual_percentage }}%)</span>
                        </div>
                        <div class="progress mb-3" style="height: 6px;">
                            {# stylelint-disable #}
                            <div class="progress-bar bg-success" role="progressbar" aria-valuenow="{{ actual_percentage }}" aria-valuemin="0" aria-valuemax="100" style="width: {{ actual_percentage|default:0 }}%;"></div>
                            {# stylelint-enable #}
                        </div>

                        <!-- –¢—Ä–µ–±—É—é—Ç –¥–æ—Ä–∞–±–æ—Ç–∫–∏ -->
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="badge bg-danger">–¢—Ä–µ–±—É—é—Ç –¥–æ—Ä–∞–±–æ—Ç–∫–∏</span>
                            <span>{{ correction_cases }} ({{ correction_percentage }}%)</span>
                        </div>
                        <div class="progress" style="height: 6px;">
                            {# stylelint-disable #}
                            <div class="progress-bar bg-danger" role="progressbar" aria-valuenow="{{ correction_percentage }}" aria-valuemin="0" aria-valuemax="100" style="width: {{ correction_percentage|default:0 }}%;"></div>
                            {# stylelint-enable #}
                        </div>
                    </div>
                    {% else %}
                    <p class="text-muted">–ö–µ–π—Å–æ–≤ –µ—â–µ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
    <script>
    document.addEventListener('DOMContentLoaded', function () {
        const projEditForm = document.getElementById('projEditForm');
        const projEditModalEl = document.getElementById('projEditModal');
        if (projEditForm) {
            projEditForm.addEventListener('submit', function (e) {
                e.preventDefault();
                const form = this;
                const formData = new FormData(form);
                fetch(form.action, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: formData
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –¥–∞—Ç—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
                        const titleEl = document.querySelector('h1');
                        if (titleEl) titleEl.textContent = '–ü—Ä–æ–µ–∫—Ç: ' + data.title;
                        const dateEl = document.querySelector('.text-muted.mb-0');
                        if (dateEl) dateEl.textContent = '–î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: ' + data.last_update_date;

                        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å
                        const modal = bootstrap.Modal.getInstance(projEditModalEl);
                        if (modal) modal.hide();
                    } else {
                        alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–µ–∫—Ç'));
                    }
                })
                .catch(err => {
                    console.error(err);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞');
                });
            });
        }

        // Delete modal logic: enable submit only when exact word ¬´–£–¥–∞–ª–∏—Ç—å¬ª entered
        const projDeleteForm = document.getElementById('projDeleteForm');
        const projDeleteInput = document.getElementById('projDeleteConfirmInput');
        const projDeleteBtn = document.getElementById('projDeleteBtn');
        const projDeleteFeedback = document.getElementById('projDeleteFeedback');

        if (projDeleteInput && projDeleteForm && projDeleteBtn) {
            projDeleteInput.addEventListener('input', function () {
                const val = this.value.trim();
                if (val === '–£–¥–∞–ª–∏—Ç—å') {
                    projDeleteBtn.disabled = false;
                    projDeleteInput.classList.remove('is-invalid');
                    if (projDeleteFeedback) projDeleteFeedback.style.display = 'none';
                } else {
                    projDeleteBtn.disabled = true;
                }
            });

            projDeleteForm.addEventListener('submit', function (e) {
                e.preventDefault();
                const inputVal = projDeleteInput.value.trim();
                if (inputVal !== '–£–¥–∞–ª–∏—Ç—å') {
                    projDeleteInput.classList.add('is-invalid');
                    if (projDeleteFeedback) projDeleteFeedback.style.display = 'block';
                    return;
                }

                // Disable button and show spinner
                projDeleteBtn.disabled = true;
                const originalText = projDeleteBtn.innerHTML;
                projDeleteBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>–£–¥–∞–ª—è—é...';

                const formData = new FormData(this);
                fetch(this.action, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: formData
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        window.location.href = data.redirect;
                    } else {
                        alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –ø—Ä–æ–µ–∫—Ç'));
                        projDeleteBtn.disabled = false;
                        projDeleteBtn.innerHTML = originalText;
                    }
                })
                .catch(err => {
                    console.error(err);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞');
                    projDeleteBtn.disabled = false;
                    projDeleteBtn.innerHTML = originalText;
                });
            });
        }
    });
    </script>
{% endblock %}